# Coverage Cache

This directory stores historical coverage data for different branches to enable coverage regression detection.

## Purpose

When running rigorous code reviews with `/envoy-review --rigorous-coverage`, the agent can:
1. Compare current branch coverage against baseline (e.g., `main`)
2. Detect coverage regressions
3. Avoid re-running expensive coverage on unchanged base branches

## Structure

```
.claude/coverage-cache/
├── README.md                    # This file
├── main.json                    # Coverage data for main branch
├── develop.json                 # Coverage data for develop branch
└── [branch-name].json          # Coverage data for other branches
```

## Coverage Data Format

Each `[branch-name].json` file contains:

```json
{
  "branch": "main",
  "commit_sha": "abc123def456...",
  "timestamp": "2025-01-20T14:30:00Z",
  "coverage_summary": {
    "lines_total": 150000,
    "lines_covered": 148500,
    "coverage_percent": 99.0,
    "functions_total": 25000,
    "functions_covered": 24800,
    "functions_percent": 99.2
  },
  "per_file_coverage": {
    "source/common/http/codec_impl.cc": {
      "lines_total": 500,
      "lines_covered": 495,
      "coverage_percent": 99.0
    }
  },
  "metadata": {
    "generated_by": "envoy-coverage-tracker.py",
    "llvm_version": "18.1.8",
    "bazel_version": "7.0.0"
  }
}
```

## Usage

### Manual Coverage Cache Management

```bash
# Save coverage for main branch
./scripts/envoy-coverage-tracker.py --branch main --save

# Check if cached coverage is stale
./scripts/envoy-coverage-tracker.py --branch main --check-stale

# Compare current branch with main
./scripts/envoy-coverage-tracker.py --compare-with main

# Clear old cache
./scripts/envoy-coverage-tracker.py --clean-cache --older-than 30d
```

### Automatic Usage by Agent

The agent automatically:
1. Checks if base branch coverage is cached
2. Validates cache is not stale (base branch hasn't changed)
3. Uses cached data if valid
4. Prompts user if cache is stale:
   - Recalculate base coverage (slow but accurate)
   - Use stale cache anyway (fast but may be inaccurate)
   - Skip comparison

## Cache Staleness

Cache is considered stale if:
- Base branch HEAD commit differs from cached commit
- Cache is older than 7 days (configurable)

## Storage

- Coverage data is stored in JSON format for easy parsing
- Files are human-readable for debugging
- Directory is NOT in `.gitignore` - coverage data can be committed
- Typical file size: 100-500 KB per branch

## Best Practices

1. **Commit main branch coverage** - Useful for CI/CD baselines
2. **Update after major merges** - Re-run coverage after significant changes
3. **Clean periodically** - Remove stale caches for deleted branches
4. **Don't cache feature branches** - Only cache long-lived branches (main, develop, release/*)

## Example Workflow

```bash
# Developer workflow
git checkout main
git pull
./scripts/envoy-coverage-tracker.py --branch main --save  # Cache main coverage

git checkout feature-branch
/envoy-review --rigorous-coverage  # Agent compares with cached main

# Agent detects: "main has 99.0% coverage, your branch has 98.8% - regression!"
```

## Files Generated by Coverage Run

When you run `test/run_envoy_bazel_coverage.sh`:
- Output: `generated/coverage/coverage.html` (full HTML report)
- Output: `generated/coverage/coverage.txt` (text summary)
- These are parsed to create the cache JSON
